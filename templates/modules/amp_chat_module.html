<amp-state id="chatState">
  <script type="application/json">
    {
      "convoId": "__CONVO_ID__"
    }
  </script>
</amp-state>
<amp-state id="currentMessage"><script type="application/json">""</script></amp-state>
<amp-state id="isSubmitting"><script type="application/json">false</script></amp-state>

<div class="chat-card">
  <div class="chat-header">__CHAT_HEADER_TITLE__</div>
  <div class="chat-window">
    <div class="chat-history">
      <div class="chat-message ai starter">
        <div class="bubble">Hi, I can help with fit, materials, shipping, and recommendations. What would you like to know?</div>
      </div>
      <amp-list
        id="chatList"
        layout="fixed-height"
        height="220"
        items="messages"
        src="__HISTORY_ENDPOINT__?token=__CHAT_TOKEN__"
      >
        <template type="amp-mustache">
          <div class="chat-message {{role}}">
            <div class="bubble"><p>{{content}}</p></div>
          </div>
        </template>
      </amp-list>
      <div id="chat-bottom"></div>
    </div>
  </div>
  <div hidden [hidden]="!isSubmitting" class="loading">Waiting for response...</div>
  <form id="chatForm" method="post" action-xhr="__CHAT_ENDPOINT__" on="
    submit:AMP.setState({
      isSubmitting: true
    });
    submit-success:chatForm.clear,chatList.refresh,chatSubmit.focus,AMP.setState({
      isSubmitting: false,
      currentMessage: '',
      chatState: {
        convoId: event.response.convo_id
      }
    });
    submit-error:AMP.setState({isSubmitting: false});
  ">
    <div class="chat-input">
      <input id="chatInput" type="text" name="message" placeholder="Ask anything about this offer" required [value]="currentMessage" [disabled]="isSubmitting" on="input:AMP.setState({currentMessage: event.value})" />
      <input type="hidden" name="token" value="__CHAT_TOKEN__" />
      <input type="hidden" name="convo_id" [value]="chatState.convoId" value="__CONVO_ID__" />
      <button id="chatSubmit" type="submit" [disabled]="isSubmitting">Send</button>
    </div>
    <div submit-error><template type="amp-mustache"><div class="loading">Error: {{error}}</div></template></div>
  </form>
</div>
